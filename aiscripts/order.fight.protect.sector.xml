<?xml version="1.0" encoding="iso-8859-1"?>
<aiscript name="order.fight.protect.sector" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="108">
  <order id="ProtectSector" name="{1972092401, 1}" description="{1972092401, 2}" category="combat" infinite="true">
    <params>
      <param name="homeSector"
        default="if @$desiredParkingPosition.{1} != null then @$desiredParkingPosition.{1} else this.assignedcontrolled.sector"
        type="sector"
        required="true" text="{1972092401, 101}">
        <input_param name="startvalue"
          value="if @$desiredParkingPosition.{1} != null then @$desiredParkingPosition.{1} else this.assignedcontrolled.sector" />
        <patch sinceversion="102" early="true" setvariable="true"
          value="if $homeSector.isclass.sector then $homeSector else $homeSector.sector" comment="Added patch to set default value" />
      </param>
      <param name="attackStations" type="bool" default="false" text="{1972092401, 111}" />
      <param name="attackStationsTactical" type="bool" default="true" text="{1972092401, 112}">
        <patch sinceversion="108" early="true" setvariable="true" value="true" comment="Give possibility to choice the attack order" />
      </param>
      <param name="attackStationsInternal" type="bool" default="false" text="{1972092401, 113}">
        <patch sinceversion="108" early="true" setvariable="true" value="false" comment="Give possibility to choice the attack order" />
      </param>
      <param name="attackShipsXL" type="bool" default="this.ship.isclass.ship_xl" text="{1972092401, 121}" />
      <param name="attackShipsL" type="bool" default="this.ship.isclass.ship_l and this.ship.isclass.ship_xl" text="{1972092401, 122}" />
      <param name="attackShipsM" type="bool" default="this.ship.isclass.ship_m and this.ship.isclass.ship_l" text="{1972092401, 123}" />
      <param name="attackShipsS" type="bool" default="this.ship.isclass.ship_s and this.ship.isclass.ship_m" text="{1972092401, 124}" />
      <param name="attackShipsOutOfStationsDistance" type="length" default="0km" text="{1972092401, 129}"
        comment="Minimal acceptable distance to the enemy station">
        <input_param name="min" value="0km" />
        <input_param name="max" value="30km" />
        <input_param name="step" value="1km" />
      </param>
      <param name="attackVisibleOnly" type="bool" default="true" text="{1972092401, 131}" />
      <param name="attackHostileOnly" type="bool" default="true" text="{1972092401, 132}" />
      <param name="relationsThreshold" default="25" type="number" text="{1972092401, 152}" comment="">
        <input_param name="startvalue" value="25" />
        <input_param name="min" value="if $attackHostileOnly then 25 else 1" />
        <input_param name="max" value="30" />
        <input_param name="step" value="1" />
        <patch sinceversion="107" early="true" setvariable="true" value="25" comment="Default, -0.32" />
      </param>
      <param name="protectPlayerShipsInSector" type="bool" default="true" text="{1972092401, 134}" />
      <param name="protectOnlyNonMilitaryShips" type="bool" default="true" text="{1972092401, 135}" />
      <param name="pursueFleeingTarget" type="bool" default="false" text="{1972092401, 133}" />
      <param name="shareTargetsBetweenFleets" type="bool" default="true" text="{1972092401, 141}" />
      <param name="attackDistanceAsPercentageOfRadarRange" type="number" default="70" text="{1972092401, 201}">
        <input_param name="min" value="10" />
        <input_param name="max" value="90" />
        <input_param name="step" value="5" />
        <patch sinceversion="105" early="true" setvariable="true" value="70" condition="@$attackDistanceAsPercentageOfRadarRange == null"
          comment="Added patch to set default value" />
      </param>
      <param name="shieldsPreserveOnFlight" type="bool" default="false" text="{1972092401, 161}">
        <patch sinceversion="108" value="if player.gameversion ge 750 then false else $shieldsPreserveOnFlight"
          comment="From 7.50 has no dependency on shields" />
      </param>
      <param name="breakOnDestructionPercentage" type="number" default="0" text="{1972092401, 171}">
        <input_param name="min" value="0" />
        <input_param name="max" value="100" />
        <input_param name="step" value="10" />
        <patch sinceversion="105" early="true" setvariable="true"
          value="if $breakOnDestructionPercentage == 40 then 0 else $breakOnDestructionPercentage"
          comment="Added patch to disable break on destruction" />
      </param>
      <param name="parkInCenterOfSector" type="bool" default="false" text="{1972092401, 181}" />
      <param name="desiredParkingPosition" type="position" default="null" required="false" text="{1972092401, 182}">
        <input_param name="class" value="class.sector" />
        <patch sinceversion="107" early="true" setvariable="true" value="null" comment="Added patch to set default value" />
      </param>
      <param name="delayBetweenScans" type="number" default="4" text="{1972092401, 191}">
        <input_param name="startvalue" value="4" />
        <input_param name="min" value="1" />
        <input_param name="max" value="90" />
        <input_param name="step" value="3" />
        <patch sinceversion="103" early="true" setvariable="true"
          value="if typeof (@$delayBetweenScans == null or @$delayBetweenScans == datatype.time) then 4 else $delayBetweenScans"
          comment="Added patch to set default value" />
      </param>
      <param name="ignoreHazardThreat" type="bool" default="false" text="{1972092401, 211}">
        <patch sinceversion="108" early="true" setvariable="true" value="false" comment="Added patch to set default value" />
      </param>
      <param name="recordActionsToLogBook" type="bool" default="true" text="{1972092401, 901}" />
      <param name="isStartedByPlayer" type="internal" default="true" text="Started by Player" />
      <param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
        <input_param name="truevalue" value="100" />
        <editable />
      </param>
    </params>
    <skill min="40" />
    <requires>
      <match shiptype="shiptype.lasertower" negate="true" />
      <match class="class.spacesuit" negate="true" />
    </requires>
    <location object="$homeSector" condition="$homeSector.zone.exists" />
    <location object="@$desiredParkingPosition.{1}" position="@$desiredParkingPosition.{2}"
      condition="@$desiredParkingPosition.{1} and @$desiredParkingPosition.{2}" />
  </order>
  <interrupts>
    <library>
      <!-- assumes variables $subordinates (group) and $subordinatesToBeUpdatedAfter (integer) are defined in the script that uses this
      library
        if $subordinates is not exists, creates it
        if $subordinatesToBeUpdatedAfter is not exists, creates it
        returns updated list of subordinates in $subordinates and sets $subordinatesToBeUpdatedAfter to player.age + 60 -->
      <actions name="SubordinatesRefresh">
        <do_if value="@$subordinates" negate="true">
          <create_group groupname="$subordinates" />
        </do_if>
        <do_if value="@$subordinatesToBeUpdatedAfter" negate="true">
          <set_value name="$subordinatesToBeUpdatedAfter" exact="player.age - 1" />
        </do_if>
        <do_if value="player.gameversion ge 750 and $subordinatesToBeUpdatedAfter lt player.age">
          <debug_text
            text="'ProtectSector [%s at %s, %s] - SubordinatesRefresh: refreshing the Subordinates group.'.
            [
              @this.assignedcontrolled.debugname,
              @this.assignedcontrolled.sector.knownname,
              @this.assignedcontrolled.fleet.name
            ]" />
          <clear_group group="$subordinates" />
          <do_if value="not this.assignedcontrolled.commander">
            <add_to_group groupname="$subordinates" list="this.assignedcontrolled.allsubordinates" />
            <do_for_each name="$subordinate" in="$subordinates" reverse="true">
              <do_if value="$subordinate.isunit or not $subordinate.subordinategroupid">
                <remove_from_group group="$subordinates" object="$subordinate" />
              </do_if>
            </do_for_each>
            <set_value name="$subordinatesToBeUpdatedAfter" exact="player.age + 60" />
          </do_if>
        </do_if>
      </actions>
      <actions name="RelationsConversionList">
        <set_value name="$relationsConversionList"
          exact="[
          -0.00064,
          -0.00128,
          -0.00192,
          -0.00256,
          -0.0032,
          -0.003981,
          -0.005012,
          -0.00631,
          -0.007943,
          -0.01,
          -0.012589,
          -0.015849,
          -0.019953,
          -0.025119,
          -0.031623,
          -0.039811,
          -0.050119,
          -0.063096,
          -0.079433,
          -0.1,
          -0.125893,
          -0.158489,
          -0.199526,
          -0.251189,
          -0.316228,
          -0.398107,
          -0.5,
          -0.630957,
          -0.794328,
          -1.0
        ]" />
      </actions>
      <actions name="ApplyExperience">
        <do_if value="$targetInfo?">
          <apply_experience entity="this" experience="'protect_sector'" chance="if $targetInfo.$isShip then 80 else 100"
            factor="if $targetInfo.$isShip then 1 else 0.5" />
          <apply_experience object="this.assignedcontrolled" role="entityrole.service" experience="'protect_sector'"
            chance="if $targetInfo.$isShip then 60 else 100" factor="if $targetInfo.$isShip then 1 else 0.4" />
          <do_for_each name="$subordinate" in="this.assignedcontrolled.subordinates">
            <set_value name="$acceptableForExperience" exact="$subordinate.subordinates.count == 0" />
            <do_if value="$acceptableForExperience" negate="true">
              <set_value name="$acceptableForExperience" exact="true" />
              <do_for_each name="$order" in="$subordinate.orders">
                <do_if value="$order.id == 'Assist'">
                  <set_value name="$acceptableForExperience" exact="false" />
                  <break />
                </do_if>
              </do_for_each>
            </do_if>
            <do_if value="$acceptableForExperience">
              <do_if value="@$targetDestroyedBy == $subordinate">
                <apply_experience entity="$subordinate.aipilot" experience="'protect_sector'"
                  chance="if $targetInfo.$isShip then 80 else 100" factor="if $targetInfo.$isShip then 1 else 0.5" />
                <apply_experience object="$subordinate" role="entityrole.service" experience="'protect_sector'"
                  chance="if $targetInfo.$isShip then 60 else 100" factor="if $targetInfo.$isShip then 1 else 0.4" />
              </do_if>
              <do_else>
                <apply_experience entity="$subordinate.aipilot" experience="'protect_sector'"
                  chance="if $targetInfo.$isShip then 80 else 100" factor="if $targetInfo.$isShip then 1 else 0.5" />
                <apply_experience object="$subordinate" role="entityrole.service" experience="'protect_sector'"
                  chance="if $targetInfo.$isShip then 60 else 100" factor="if $targetInfo.$isShip then 1 else 0.4" />
                <do_for_each name="$subSubordinate" in="$subordinate.allsubordinates">
                  <apply_experience entity="$subSubordinate.aipilot" experience="'protect_sector'"
                    chance="if $targetInfo.$isShip then 80 else 100" factor="if $targetInfo.$isShip then 0.7 else 0.4" />
                  <apply_experience object="$subSubordinate" role="entityrole.service" experience="'protect_sector'"
                    chance="if $targetInfo.$isShip then 60 else 100" factor="if $targetInfo.$isShip then 0.6 else 0.3" />
                </do_for_each>
              </do_else>
            </do_if>
          </do_for_each>
        </do_if>
        <remove_value name="$targetDestroyedBy" />
      </actions>
      <actions name="ResupplyChecksInit">
        <create_list name="$randomizeInitialResupply" />
        <do_all exact="10" counter="$r">
          <append_to_list name="$randomizeInitialResupply" exact="$r + 2" />
        </do_all>
        <set_value name="$resupplyCheck" exact="player.age + $randomizeInitialResupply.random * 5min" />
        <remove_value name="$randomizeInitialResupply" />
      </actions>
      <actions name="ResupplyWorkaroundRefresh">
        <do_for_each name="$subordinate" in="this.$escortgroup">
          <set_value name="$subordinate.pilot.$playerOwnedWorkaroundForRestock" exact="true" />
        </do_for_each>
        <set_value name="this.assignedcontrolled.pilot.$playerOwnedWorkaroundForRestock" exact="true" />
      </actions>
      <actions name="ScanForEnemyShips">
        <clear_list list="$ships" />
        <do_if value="$attackVisibleOnly">
          <do_if value="$relationsThreshold ge 25">
            <!-- <debug_text text="'ProtectSector [%s at %s, %s] : Find Visible and Hostile'.
                [
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name
                ]" /> -->
            <find_ship name="$ships" space="this.assignedcontrolled.sector" class="$classesForAttack" recursive="true" multiple="true" isinliveview="true"
              ishostileto="this.owner" sortdescending="false"
              sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}">
              <match trueowner="faction.player" negate="true" />
              <match race="race.drone" negate="true" />
            </find_ship>
          </do_if>
          <do_else>
            <!-- <debug_text text="'ProtectSector [%s at %s, %s] : Find Visible'.
                [
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name
                ]" /> -->
            <find_ship name="$ships" space="this.assignedcontrolled.sector" class="$classesForAttack" recursive="true" multiple="true" isinliveview="true"
              sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
              sortdescending="false">
              <match trueowner="faction.player" negate="true" />
              <match race="race.drone" negate="true" />
            </find_ship>
          </do_else>
        </do_if>
        <do_else>
          <do_if value="$relationsThreshold ge 25">
            <!-- <debug_text text="'ProtectSector [%s at %s, %s] : Find Hostile'.
                [
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name
                ]" /> -->
            <find_ship name="$ships" space="this.assignedcontrolled.sector" class="$classesForAttack" recursive="true" multiple="true" ishostileto="this.owner"
              sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
              sortdescending="false">
              <match trueowner="faction.player" negate="true" />
              <match race="race.drone" negate="true" />
            </find_ship>
          </do_if>
          <do_else>
            <!-- <debug_text text="'ProtectSector [%s at %s, %s] : Find Any'.
                [
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name
                ]" /> -->
            <find_ship name="$ships" space="this.assignedcontrolled.sector" class="$classesForAttack" recursive="true" multiple="true"
              sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
              sortdescending="false">
              <match trueowner="faction.player" negate="true" />
              <match race="race.drone" negate="true" />
            </find_ship>
          </do_else>
        </do_else>
        <debug_text
          text="'ProtectSector [%,s at %s, %s] - ScanForEnemyShips: found %s ships.'.
            [
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name,
              $ships.count
            ]" />
      </actions>
      <actions name="ScanForEnemyStations">
        <clear_list list="$stations" />
        <do_if value="$attackVisibleOnly">
          <do_if value="$relationsThreshold ge 25">
            <do_if value="$macrosToSkip.count == 1">
              <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station, class.buildstorage]" recursive="true" multiple="true"
                ishostileto="this.owner" known="true"
                sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                  (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
                sortdescending="false">
                <match macro="$macrosToSkip.{1}" negate="true" />
              </find_object>
            </do_if>
            <do_else>
              <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station, class.buildstorage]" recursive="true" multiple="true"
                ishostileto="this.owner" known="true"
                sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                  (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) +
                  (if $macrosToSkip.indexof.{@loop.element.macro} == 0 then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
                sortdescending="false" />
            </do_else>
          </do_if>
          <do_else>
            <do_if value="$macrosToSkip.count == 1">
              <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station, class.buildstorage]" recursive="true" multiple="true"
                known="true"
                sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                  (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
                sortdescending="false">
                <match_relation_to object="this.assignedcontrolled" relation="neutral" comparison="le" />
                <match macro="$macrosToSkip.{1}" negate="true" />
              </find_object>
            </do_if>
            <do_else>
              <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station, class.buildstorage]" recursive="true" multiple="true"
                known="true"
                sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                  (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) +
                  (if $macrosToSkip.indexof.{@loop.element.macro} == 0 then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
                sortdescending="false">
                <match_relation_to object="this.assignedcontrolled" relation="neutral" comparison="le" />
              </find_object>
            </do_else>
          </do_else>
        </do_if>
        <do_else>
          <do_if value="$relationsThreshold ge 25">
            <do_if value="$macrosToSkip.count == 1">
              <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station, class.buildstorage]" recursive="true" multiple="true"
                ishostileto="this.owner"
                sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                  (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
                sortdescending="false">
                <match macro="$macrosToSkip.{1}" negate="true" />
              </find_object>
            </do_if>
            <do_else>
              <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station, class.buildstorage]" recursive="true" multiple="true"
                ishostileto="this.owner"
                sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                  (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) +
                  (if $macrosToSkip.indexof.{@loop.element.macro} == 0 then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
                sortdescending="false" />
            </do_else>
          </do_if>
          <do_else>
            <do_if value="$macrosToSkip.count == 1">
              <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station, class.buildstorage]" recursive="true" multiple="true"
                sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                  (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
                sortdescending="false">
                <match_relation_to object="this.assignedcontrolled" relation="neutral" comparison="le" />
                <match macro="$macrosToSkip.{1}" negate="true" />
              </find_object>
            </do_if>
            <do_else>
              <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station, class.buildstorage]" recursive="true" multiple="true"
                sortbyvalue="(if @loop.element.pilot.$ignoreTime gt player.age then 1000km else 0km) +
                  (if @loop.element.relationto.{this.owner} le $relationsThresholdInternal then 0km else 1000km) +
                  (if $macrosToSkip.indexof.{@loop.element.macro} == 0 then 0km else 1000km) + loop.element.distanceto.{this.assignedcontrolled}"
                sortdescending="false">
                <match_relation_to object="this.assignedcontrolled" relation="neutral" comparison="le" />
              </find_object>
            </do_else>
          </do_else>
        </do_else>
      </actions>
      <actions name="HazardInSector">
        <do_if value="$homeSector.hashazardousregion and @$ignoreHazardThreat != true">
          <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1101}.[$textUnit, $textHomeSector]"
            interaction="showonmap" object="this.assignedcontrolled" />
          <debug_text
            text="'ProtectSector [%s at %s, %s] - HazardInSector: Hazard in sector %s. Stopping to work...'.
            [
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name,
              $homeSector.knownname
            ]" />
          <create_order object="this.assignedcontrolled" id="'Wait'" default="true" />
        </do_if>
      </actions>
    </library>
    <handler ref="AttackHandler" />
    <handler ref="MissileLockHandler" />
    <handler ref="ScannedHandler" />
    <handler ref="InspectedHandler" />
    <handler ref="FoundAbandonedHandler" />
    <handler ref="FoundLockboxHandler" />
    <handler ref="ResupplyHandler" />
    <handler>
      <conditions>
        <check_all>
          <event_game_loaded />
          <debug_text
            text="'%s [%s at %s, %s] - Game loaded with script version %s'.
            [
              player.age,
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name,
              @$scriptVersion
            ]" />
          <check_any>
            <check_value value="@$scriptVersion lt 101" />
          </check_any>
        </check_all>
      </conditions>
      <actions>
        <debug_text
          text="'ProtectSector [%s at %s, %s] - Re-init for versions %s prior to 1.01'
          .[
            this.assignedcontrolled.debugname,
            this.assignedcontrolled.sector.knownname,
            this.assignedcontrolled.fleet.name,
            @$scriptVersion,
          ]" />
        <do_if value="@$scriptVersion lt 101">
          <create_order object="this.assignedcontrolled" id="'ProtectSector'" default="true">
            <param name="homeSector" value="if $ps_space.isclass.sector then $ps_space else $ps_space.sector" />
            <param name="attackStations" value="$ps_attack_stations" />
            <param name="attackStationsTactical" value="true" />
            <param name="attackStationsInternal" value="false" />
            <param name="attackShipsXL" value="$ps_attack_xl" />
            <param name="attackShipsL" value="$ps_attack_l" />
            <param name="attackShipsM" value="$ps_attack_m" />
            <param name="attackShipsS" value="$ps_attack_s" />
            <param name="attackShipsOutOfStationsDistance" value="$ps_attack_farther_from_station" />
            <param name="attackVisibleOnly" value="$ps_visible_only" />
            <param name="attackHostileOnly" value="$ps_hostile_only" />
            <param name="relationsThreshold" value="25" />
            <param name="pursueFleeingTarget" value="$ps_pursue" />
            <param name="protectPlayerShipsInSector" value="true" />
            <param name="protectOnlyNonMilitaryShips" value="true" />
            <param name="shareTargetsBetweenFleets" value="if $ps_target_share? then $ps_target_share else $target_share" />
            <param name="attackDistanceAsPercentageOfRadarRange" value="70" />
            <param name="shieldsPreserveOnFlight" value="if player.gameversion ge 750 then false else $ps_noboost" />
            <param name="breakOnDestructionPercentage" value="0" />
            <param name="parkInCenterOfSector" value="$ps_park" />
            <param name="desiredParkingPosition" value="null" />
            <param name="delayBetweenScans" value="4" />
            <param name="ignoreHazardThreat" value="false" />
            <param name="recordActionsToLogBook" value="true" />
            <param name="isStartedByPlayer" value="false" />
          </create_order>
          <return />
        </do_if>
      </actions>
    </handler>
    <handler>
      <conditions>
        <check_all>
          <event_player_owned_attacked />
          <check_value value="@$protectPlayerShipsInSector" />
          <check_any>
            <check_value value="@$protectOnlyNonMilitaryShips" negate="true" />
            <check_all>
              <check_value value="@$protectOnlyNonMilitaryShips" />
              <check_any>
                <check_value value="@event.object.primarypurpose != purpose.fight" />
                <check_value value="@event.object.isclass.station" />
              </check_any>
            </check_all>
          </check_any>
          <check_value value="@event.param.trueowner.hasrelation.enemy.{this.trueowner}" />
          <check_value value="@event.param.pilot.race == race.drone" negate="true" />
          <check_value value="@event.object.sector == this.assignedcontrolled.sector and $homeSector == this.assignedcontrolled.sector" />
          <check_value value="@event.object.isclass.ship or event.object.isclass.station" />
          <check_value value="@event.object != this.assignedcontrolled" />
          <check_value value="@event.object.order.id != 'ProtectSector'" />
          <check_value value="@event.object.toplevelcommander != 'ProtectSector'" />
          <check_value value="@event.object.assignedcontrolled.defaultorder.id != 'ProtectSector'" />
          <check_value value="@event.object.assignedcontrolled.toplevelcommander.defaultorder.id != 'ProtectSector'" />
          <check_value value="@event.param.isclass.{$classesForAttack}" />
          <check_value value="@$target == null" />
          <check_value value="@$targetOnResponse == null" />
        </check_all>
      </conditions>
      <actions>
        <set_value name="$idleTill" exact="player.age" />
        <debug_text
          text="'ProtectSector [%s at %s, %s] -  %s, our : %s {%s} in sector: %s with order: %s, top commander:  %s {%s} in sector: %s with order: %s,  assigned:  %s {%s} in sector: %s with order: %s, assigned top commander:  %s {%s} in sector: %s with order: %s, attacker: %s {%s}'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name,
              @event.name,
              @event.object.debugname,
              @event.object.class,
              @event.object.sector.knownname,
              @event.object.defaultorder.id,
              @event.object.toplevelcommander.debugname,
              @event.object.toplevelcommander.class,
              @event.object.toplevelcommander.sector.knownname,
              @event.object.toplevelcommander.defaultorder.id,
              @event.object.assignedcontrolled.debugname,
              @event.object.assignedcontrolled.class,
              @event.object.assignedcontrolled.sector.knownname,
              @event.object.assignedcontrolled.defaultorder.id,
              @event.object.assignedcontrolled.toplevelcommander.debugname,
              @event.object.assignedcontrolled.toplevelcommander.class,
              @event.object.assignedcontrolled.toplevelcommander.sector.knownname,
              @event.object.assignedcontrolled.toplevelcommander.defaultorder.id,
              @event.param.debugname,
              @event.param.class
            ]" />
        <set_value name="$targetOnResponse" exact="event.param" />
        <do_if value="$targetOnResponse.coverowner">
          <signal_objects object="$targetOnResponse" param="'LoseCover'" param2="true" />
        </do_if>
        <do_if value="$recordActionsToLogBook">
          <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
          <do_if
            value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
            <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
          </do_if>
          <set_value name="$textEnemyClass" exact="if event.param.isclass.ship then $textShip else $textStation" />
          <set_value name="$textEnemy" exact="{1972092401, 1013}.[$textEnemyClass, event.param.name, event.param.idcode]" />
          <set_value name="$textOur" exact="{1972092401, 1014}.[event.object.name, event.object.idcode]" />
          <write_to_logbook category="general" title="$textTitle"
            text="{1972092401, 1033}.[$textUnit, $textOur, $textHomeSector, $textEnemy]" interaction="showonmap"
            object="this.assignedcontrolled" />
        </do_if>
        <apply_experience entity="this" experience="'ship_disable_easy'" chance="60" />
        <clear_list list="$ships" />
        <append_to_list name="$ships" exact="$targetOnResponse" />
        <abort_called_scripts resume="protectPlayerShipsCheck" />
      </actions>
    </handler>
    <handler>
      <conditions>
        <check_any>
          <event_object_destroyed group="$targets" />
          <event_object_abandoned group="$targets" />
          <event_object_changed_sector group="$targets" />
          <event_object_target_invalid object="this.assignedcontrolled" />
        </check_any>
      </conditions>
      <actions>
        <debug_text
          text="'ProtectSector [%s at %s, %s] - Event %s : %s{%s} status: iswreck: %s, isoperational: %s,  pilot: %s (%s), param: %s {%s}, target info - %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name,
              @event.name,
              @event.object.debugname,
              @event.object.class,
              @event.object.iswreck,
              @event.object.isoperational,
              @event.object.pilot,
              event.object.pilot?,
              @event.param.debugname,
              @event.param.class,
              @$targetInfo
            ]" />
        <do_if value="$targetInfo? and $targetInfo != null and $targetInfo.$name? and @$targetInfo.$isShip">
          <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
          <do_if
            value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
            <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
          </do_if>
          <set_value name="$textEnemyClass" exact="if @$targetInfo.$isShip then $textShip else $textStation" />
          <set_value name="$textEnemy" exact="{1972092401, 1013}.[$textEnemyClass, $targetInfo.$name, $targetInfo.$idcode]" />
          <do_if value="event.name == 'event_object_changed_sector'">
            <do_if value="$homeSector !=  event.object.sector">
              <do_if value="$recordActionsToLogBook">
                <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1043}.[$textUnit, $textEnemy, $textHomeSector]"
                  interaction="showonmap" object="this.assignedcontrolled" />
              </do_if>
              <abort_called_scripts resume="targetSearching" />
            </do_if>
          </do_if>
          <do_else>
            <do_if value="$recordActionsToLogBook">
              <do_if value="event.name == 'event_object_destroyed'">
                <set_value name="$textDestroyedBy" exact="{1972092401, 1015}.[@event.param.name, @event.param.idcode]" />
                <write_to_logbook category="general" title="$textTitle"
                  text="{1972092401, 1041}.[$textUnit, $textEnemy, $textHomeSector, $textDestroyedBy]" interaction="showonmap"
                  object="this.assignedcontrolled" />
              </do_if>
              <do_elseif value="event.name == 'event_object_abandoned'">
                <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1042}.[$textUnit, $textEnemy, $textHomeSector]"
                  interaction="showonmap" object="this.assignedcontrolled" />
              </do_elseif>
            </do_if>
            <do_if
              value="@event.param == this.assignedcontrolled or @this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.subordinates.indexof.{event.param} gt 0">
              <set_value name="$targetDestroyedBy" exact="event.param" />
              <include_interrupt_actions ref="ApplyExperience" />
            </do_if>
            <abort_called_scripts resume="targetSearching" />
          </do_else>
        </do_if>
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_destroyed group="@$subordinates" check="false" />
        <check_value value="@this.assignedcontrolled.fleetunits.count" />
        <check_value value="not @this.assignedcontrolled.commander" />
        <check_value value="not @this.assignedcontrolled.fleetunit" />
        <check_value value="player.gameversion ge 750" />
      </conditions>
      <actions>
        <debug_text
          text="'ProtectSector [%s at %s, %s] - SubordinateLostHandler: requesting fleet replacements for %s units.'.
            [
              @this.assignedcontrolled.debugname,
              @this.assignedcontrolled.sector.knownname,
              @this.assignedcontrolled.fleet.name,
              @this.assignedcontrolled.fleetunits.count
            ]" />
        <!-- prepare group of subordinates to request fleet reinstate -->
        <include_interrupt_actions ref="SubordinatesRefresh" />
        <signal_objects object="player.entity" param="'reconstitute_fleet'" param2="this.assignedcontrolled"
          param3="this.assignedcontrolled.fleetunits" />
      </actions>
    </handler>
    <handler consume="false">
      <conditions>
        <event_object_subordinate_removed object="this.assignedcontrolled" />
      </conditions>
      <actions>
        <debug_text
          text="'ProtectSector [%s at %s, %s] - SubordinateRemovedHandler: subordinate %s was removed.'.
            [
              @this.assignedcontrolled.debugname,
              @this.assignedcontrolled.sector.knownname,
              @this.assignedcontrolled.fleet.name,
              @event.param.debugname
            ]" />
        <set_value name="$subordinate" exact="event.param" />
        <do_if value="@$subordinate.pilot != null">
          <do_if value="@$subordinate.pilot.$escortgroup != null">
            <do_for_each name="$escortShip" in="$subordinate.pilot.$escortgroup">
              <remove_value name="$escortShip.pilot.$playerOwnedWorkaroundForRestock" />
            </do_for_each>
          </do_if>
          <do_for_each name="$escortShip" in="$subordinate.subordinates">
            <remove_value name="$escortShip.pilot.$playerOwnedWorkaroundForRestock" />
          </do_for_each>
          <remove_value name="$subordinate.pilot.$playerOwnedWorkaroundForRestock" />
        </do_if>
        <remove_value name="$subordinate" />
      </actions>
    </handler>
    <handler consume="false">
      <conditions>
        <event_object_subordinate_added object="this.assignedcontrolled" />
      </conditions>
      <actions>
        <debug_text
          text="'ProtectSector [%s at %s, %s] - SubordinateAddedHandler: subordinate %s is added.'.
          [
            @this.assignedcontrolled.debugname,
            @this.assignedcontrolled.sector.knownname,
            @this.assignedcontrolled.fleet.name,
            @event.param.debugname
          ]" />
        <set_value name="$subordinate" exact="event.param" />
        <do_if value="@$subordinate.pilot.$escortgroup != null">
          <do_for_each name="$escortShip" in="$subordinate.pilot.$escortgroup">
            <set_value name="$escortShip.pilot.$playerOwnedWorkaroundForRestock" exact="true" />
          </do_for_each>
        </do_if>
        <do_for_each name="$escortShip" in="$subordinate.subordinates">
          <set_value name="$escortShip.pilot.$playerOwnedWorkaroundForRestock" exact="true" />
        </do_for_each>
        <set_value name="$subordinate.pilot.$playerOwnedWorkaroundForRestock" exact="true" />
        <remove_value name="$subordinate" />
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="this.assignedcontrolled" param="'ProtectSectorReScan'" />
        <check_value value="@$idleTill gt player.age" />
      </conditions>
      <actions>
        <debug_text
          text="'ProtectSector [%s at %s, %s] - ReScan requested. Finish after: %s. ReScan delay: %s.'.
            [
              @this.assignedcontrolled.debugname,
              @this.assignedcontrolled.sector.knownname,
              @this.assignedcontrolled.fleet.name,
              @$idleTill - player.age,
              $delayBetweenScansInSeconds
            ]" />
        <include_interrupt_actions ref="ScanForEnemyShips" />
        <do_if
          value="@$ships.count gt 0 and @$ships.{1}.relationto.{this.owner} le $relationsThresholdInternal and (@$ships.{1}.pilot.$ignoreTime == null or @$ships.{1}.pilot.$ignoreTime le player.age)">
          <set_value name="$idleTill" exact="0" />
          <debug_text
            text="'ProtectSector [%s at %s, %s] - ReScan result. Target found: %s. Relation: %s. Threshold: %s. Distance: %s.'.
            [
              @this.assignedcontrolled.debugname,
              @this.assignedcontrolled.sector.knownname,
              @this.assignedcontrolled.fleet.name,
              @$ships.{1}.debugname,
              @$ships.{1}.relationto.{this.owner},
              $relationsThresholdInternal,
              @$ships.{1}.distanceto.{this.assignedcontrolled}
            ]" />
          <abort_called_scripts resume="protectPlayerShipsCheck" />
        </do_if>
        <do_else>
          <do_if value="$attackStations and (player.age - $lastStationScan) ge 30s">
            <include_interrupt_actions ref="ScanForEnemyStations" />
            <debug_text
              text="'ProtectSector [%s at %s, %s] - ReScan stations result. Target found: %s. Relation: %s. Threshold: %s. Distance: %s.'.
              [
                @this.assignedcontrolled.debugname,
                @this.assignedcontrolled.sector.knownname,
                @this.assignedcontrolled.fleet.name,
                @$stations.{1}.debugname,
                @$stations.{1}.relationto.{this.owner},
                $relationsThresholdInternal,
                @$stations.{1}.distanceto.{this.assignedcontrolled}
              ]" />
            <set_value name="$lastStationScan" exact="player.age" />
            <do_if
              value="$stations.count gt 0 and @$stations.{1}.relationto.{this.owner} le $relationsThresholdInternal and $macrosToSkip.indexof.{@$stations.{1}.macro} gt 0">
              <set_value name="$idleTill" exact="0" />
              <abort_called_scripts resume="checkForEnemyStations" />
            </do_if>
          </do_if>
          <do_if value="($idleTill - player.age) gt $delayBetweenScansInSeconds">
            <signal_objects object="this.assignedcontrolled" param="'ProtectSectorReScan'" delay="$delayBetweenScansInSeconds" />
          </do_if>
          <do_else>
            <set_value name="$idleDelay" exact="$updateTime" />
            <set_value name="$idleTill" exact="0" />
            <abort_called_scripts resume="goingIdle" />
          </do_else>
        </do_else>
      </actions>
    </handler>
  </interrupts>
  <init>
    <set_value name="$scriptVersion" exact="108" />

    <set_value name="$shieldsPreserveOnFlight" exact="if player.gameversion ge 750 then false else $shieldsPreserveOnFlight" />

    <set_value name="$oneSecond" exact="1s" />
    <set_value name="$delayBetweenScansInSeconds" exact="$oneSecond * $delayBetweenScans" />
    <set_value name="$macrosToSkip" exact="[macro.asteroid_turret_m_01_macro]" />

    <include_interrupt_actions ref="RelationsConversionList" />

    <debug_text
      text="'ProtectSector [%s at %s, %s] - Version: %s. Home Sector: %s. Attack Stations: %s (Tactical: %s, Internal: %s). Attack Ships XL: %s. Attack Ships L: %s. Attack Ships M: %s. Attack Ships S: %s. Attack Ships Out Of Stations Distance: %s. Attack Visible Only: %s. Attack Hostile Only: %s. Relation Threshold: %s. Protect Player Ships In Sector: %s. Protect Only Non Military Ships: %s. Pursue Fleeing Target: %s. Share Targets Between Fleets: %s. Shields Preserve On Flight: %s. Break On Destruction Percentage: %s. Park In Center Of Sector: %s. Desired Parking Position: %s at %s. Delay Between Scans: %s, in seconds: %s. Ignore Hazard Threat: %s. Record Actions To Log Book: %s.'
        .[
          this.assignedcontrolled.debugname,
          this.assignedcontrolled.sector.knownname,
          this.assignedcontrolled.fleet.name,
          @$scriptVersion,
          $homeSector.knownname,
          $attackStations,
          $attackStationsTactical,
          $attackStationsInternal,
          $attackShipsXL,
          $attackShipsL,
          $attackShipsM,
          $attackShipsS,
          $attackShipsOutOfStationsDistance,
          $attackVisibleOnly,
          $attackHostileOnly,
          $relationsThreshold,
          $protectPlayerShipsInSector,
          $protectOnlyNonMilitaryShips,
          $pursueFleeingTarget,
          $shareTargetsBetweenFleets,
          $shieldsPreserveOnFlight,
          $breakOnDestructionPercentage,
          $parkInCenterOfSector,
          @$desiredParkingPosition.{2},
          @$desiredParkingPosition.{1}.name,
          $delayBetweenScans,
          $delayBetweenScansInSeconds,
          $ignoreHazardThreat,
          $recordActionsToLogBook
        ]" />

    <set_value name="$textTitle" exact="{1972092401, 1000}" />
    <set_value name="$textShip" exact="{1972092401, 1001}" />
    <set_value name="$textStation" exact="{1972092401, 1002}" />
    <set_value name="$textHomeSector" exact="{1972092401, 1003}.[$homeSector.knownname]" />

    <do_if value="this.assignedcontrolled.aipilot.$targetInfo?">
      <set_value name="$targetInfo" exact="this.assignedcontrolled.aipilot.$targetInfo" />
      <set_value name="$target" exact="@$targetInfo.$target" />
      <set_value name="$isStartedByPlayer" exact="false" />
      <debug_text
        text="'ProtectSector [%s at %s, %s] - Station after attack : %s {%s}, iswreck: %s, targetInfo: %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.fleet.name,
                $target.debugname,
                $target.class,
                $target.iswreck,
                $targetInfo
              ]" />


      <do_if value="$target.iswreck">

        <include_interrupt_actions ref="ApplyExperience" />

        <do_if value="$recordActionsToLogBook">
          <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
          <do_if
            value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
            <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
          </do_if>
          <set_value name="$textEnemy" exact="{1972092401, 1013}.[$textStation, $targetInfo.$name, $targetInfo.$idcode]" />
          <set_value name="$textDestroyedBy" exact="{1972092401, 1015}.[@$target.lastattacker.name, @$target.lastattacker.idcode]" />
          <write_to_logbook category="general" title="$textTitle"
            text="{1972092401, 1041}.[$textUnit, $textEnemy, $textHomeSector, $textDestroyedBy]" interaction="showonmap"
            object="this.assignedcontrolled" />
        </do_if>
        <set_value name="$IdleAfterStationDestroy" exact="true" />
      </do_if>
      <remove_value name="this.assignedcontrolled.aipilot.$targetInfo" />
    </do_if>

    <set_value name="$target" exact="null" />
    <set_value name="$targetOnResponse" exact="null" />

    <create_group groupname="$targets" />

    <do_if value="$parkInCenterOfSector and $desiredParkingPosition != null">
      <edit_order_param order="this.assignedcontrolled.order" param="'desiredParkingPosition'" value="null" />
    </do_if>
    <do_elseif
      value="$desiredParkingPosition != null and @$desiredParkingPosition.{1}.isclass.sector and @$desiredParkingPosition.{1} != $homeSector">
      <edit_order_param order="this.assignedcontrolled.order" param="'homeSector'" value="$desiredParkingPosition.{1}" />
    </do_elseif>

    <do_if value="@$attackStationsInternal == true">
      <set_value name="$attackStationsInternalAcceptable"
        exact="this.assignedcontrolled.iscapitalship and this.assignedcontrolled.type != shiptype.carrier" />
      <set_value name="$incompatibleAssignments"
        exact="[
          assignment.defence,
          assignment.attack,
          assignment.interception,
          assignment.bombardment,
          assignment.assist
        ]" />
      <do_if value="$attackStationsInternalAcceptable">
        <do_for_each name="$subordinate" in="this.assignedcontrolled.allsubordinates">
          <do_if
            value="not $subordinate.iscapitalship and $incompatibleAssignments.indexof.{@$subordinate.assignment} gt 0">
            <set_value name="$attackStationsInternalAcceptable" exact="false" />
            <break />
          </do_if>
        </do_for_each>
      </do_if>
      <do_if value="$attackStationsInternalAcceptable" negate="true">
        <edit_order_param order="this.assignedcontrolled.order" param="'attackStationsInternal'" value="false" />
        <debug_text
          text="'ProtectSector [%s at %s, %s] - Attack stations internal mode can not be used. Reset to : %s.'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name,
              $attackStationsInternalAcceptable
            ]" />
      </do_if>
      <remove_value name="$attackStationsInternalAcceptable" />
      <remove_value name="$incompatibleAssignments" />
    </do_if>

    <set_command_action commandaction="commandaction.scanningto" param="$homeSector" />

    <do_if value="$attackHostileOnly and $relationsThreshold lt 25">
      <set_value name="$relationsThreshold" exact="25" />
      <edit_order_param order="this.assignedcontrolled.order" param="'relationsThreshold'" value="25" />
    </do_if>
    <set_value name="$relationsThresholdInternal" exact="$relationsConversionList.{$relationsThreshold}" />

    <debug_text
      text="'ProtectSector [%s at %s, %s] - Started (by player: %s) with %s subordinates and %s as top commander. Relation Threshold: %s (%s).'
        .[
          this.assignedcontrolled.debugname,
          this.assignedcontrolled.sector.knownname,
          this.assignedcontrolled.fleet.name,
          $isStartedByPlayer,
          @this.assignedcontrolled.subordinates.count,
          @this.assignedcontrolled.toplevelcommander.debugname,
          $relationsThresholdInternal,
          $relationsThreshold
        ]" />


    <set_value name="$parkingPosition" exact="null" />

    <do_if value="$parkInCenterOfSector">
      <set_value name="$dx" min="-5" max="5" />
      <set_value name="$dy" min="-5" max="5" />
      <set_value name="$dz" min="-5" max="5" />
      <create_position name="$parkingPosition" x="$homeSector.coreposition.x + $dx * 1km" y="$homeSector.coreposition.y + 30km + $dy * 1km"
        z="$homeSector.coreposition.z + $dz * 1km" space="$homeSector.sector" />
    </do_if>
    <do_elseif value="@$desiredParkingPosition != null and @$desiredParkingPosition.{2} != null">
      <set_value name="$parkingPosition" exact="@$desiredParkingPosition.{2}" />
    </do_elseif>

    <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
    <do_if
      value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
      <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
    </do_if>

    <do_if value="$isStartedByPlayer">
      <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1021}.[$textUnit, $textHomeSector]" interaction="showonmap"
        object="this.assignedcontrolled" />
    </do_if>

    <set_value name="$classesForAttack" exact="[]" />
    <set_value name="$classesAcceptableForAttack" exact="[class.ship_xs, class.ship_s, class.ship_m, class.ship_l, class.ship_xl]" />

    <do_if value="$attackShipsXL">
      <append_to_list name="$classesForAttack" exact="class.ship_xl" />
    </do_if>
    <do_else>
      <remove_from_list name="$classesAcceptableForAttack" exact="class.ship_xl" />
    </do_else>
    <do_if value="$attackShipsL">
      <append_to_list name="$classesForAttack" exact="class.ship_l" />
    </do_if>
    <do_elseif value="$attackShipsXL" negate="true">
      <remove_from_list name="$classesAcceptableForAttack" exact="class.ship_l" />
    </do_elseif>
    <do_if value="$attackShipsM">
      <append_to_list name="$classesForAttack" exact="class.ship_m" />
    </do_if>
    <do_elseif value="$attackShipsXL or $attackShipsL" negate="true">
      <remove_from_list name="$classesAcceptableForAttack" exact="class.ship_m" />
    </do_elseif>
    <do_if value="$attackShipsS">
      <append_to_list name="$classesForAttack" exact="class.ship_s" />
      <append_to_list name="$classesForAttack" exact="class.ship_xs" />
    </do_if>

    <set_value name="$targetDistanceToIsNotDecreasing" exact="0" />
    <set_value name="$approachingIterationsCount" exact="0" />

    <set_value name="$isStartedByPlayer" exact="false" />

    <include_interrupt_actions ref="SubordinatesRefresh" />

    <set_value name="$positionIdleTime" exact="player.age" />

    <include_interrupt_actions ref="ResupplyChecksInit" />
    <create_list name="$ships" />
    <create_list name="$stations" />
    <set_value name="$updateTime"
      exact="if this.assignedcontrolled.isclass.ship_xl then 15min else (if this.assignedcontrolled.isclass.ship_l then 9min else 4min)" />
    <set_value name="$idleDelay" exact="$updateTime" />
    <set_value name="$idleTill" exact="0" />
    <set_value name="$lastStationScan" exact="player.age" />
  </init>
  <patch sinceversion="104">
    <set_value name="$idleDelay" exact="$delayBetweenScansInSeconds" />
    <debug_text
      text="'ProtectSector [%s at %s, %s] - Patched for version 104. Idle delay: %s.'
        .[
          this.assignedcontrolled.debugname,
          this.assignedcontrolled.sector.knownname,
          this.assignedcontrolled.fleet.name,
          $idleDelay
        ]" />
  </patch>
  <patch sinceversion="106">
    <include_interrupt_actions ref="SubordinatesRefresh" />
    <set_value name="$scriptVersion" exact="106" />
  </patch>
  <patch sinceversion="107">
    <include_interrupt_actions ref="RelationsConversionList" />
    <set_value name="$relationsThresholdInternal" exact="-0.32" />
    <set_value name="$parkingPosition" exact="null" />
    <do_if value="$parkInCenterOfSector">
      <set_value name="$dx" min="-5" max="5" />
      <set_value name="$dy" min="-5" max="5" />
      <set_value name="$dz" min="-5" max="5" />
      <create_position name="$parkingPosition" x="$homeSector.coreposition.x + $dx * 1km" y="$homeSector.coreposition.y + 30km + $dy * 1km"
        z="$homeSector.coreposition.z + $dz * 1km" space="$homeSector.sector" />
      <set_value name="$parkedAtPosition"
        exact="($parkingPosition != null) and (this.assignedcontrolled.distanceto.{$parkingPosition} le 5km)" />
    </do_if>
    <do_else>
      <set_value name="$parkedAtPosition" exact="false" />
    </do_else>
    <set_value name="$positionIdleTime" exact="player.age" />
    <set_value name="$scriptVersion" exact="107" />
  </patch>
  <patch sinceversion="108">
    <include_interrupt_actions ref="ResupplyChecksInit" />
    <include_interrupt_actions ref="ResupplyWorkaroundRefresh" />
    <create_list name="$ships" />
    <create_list name="$stations" />
    <set_value name="$updateTime"
      exact="if this.assignedcontrolled.isclass.ship_xl then 15min else (if this.assignedcontrolled.isclass.ship_l then 9min else 4min)" />
    <set_value name="$idleDelay" exact="$updateTime" />
    <set_value name="$idleTill" exact="0" />
    <set_value name="$lastStationScan" exact="player.age" />
    <include_interrupt_actions ref="HazardInSector" />
  </patch>
  <attention min="unknown">
    <actions>
      <!-- START ******************************************************************************* -->

      <label name="start" />

      <include_interrupt_actions ref="HazardInSector" />

      <do_if value="this.assignedcontrolled.sector != $homeSector">
        <wait min="500ms" max="1s" />
        <resume label="flightToHomeSector" />
      </do_if>

      <do_if value="@$IdleAfterStationDestroy == true">
        <set_value name="$idleDelay" exact="if this.assignedcontrolled.isclass.ship_xl then 1min else 30s" />
        <resume label="goingIdle" />
      </do_if>

      <!-- SEARCH ******************************************************************************* -->
      <label name="targetSearching" />

      <do_if value="$scriptVersion != 108">
        <return />
      </do_if>

      <do_if value="this.assignedcontrolled.sector != $homeSector">
        <resume label="flightToHomeSector" />
      </do_if>

      <set_value name="$target" exact="null" />

      <do_if value="not $targets? or $targets == null">
        <create_group groupname="$targets" />
      </do_if>
      <clear_group group="$targets" />

      <do_if value="not $targetInfo? or $targetInfo == null">
        <set_value name="$targetInfo" exact="table[]" />
      </do_if>
      <clear_table table="$targetInfo" />

      <do_if value="this.assignedcontrolled.order" comment="Safety check in case the script is called from non-order script">
        <!-- Required for all infinite orders, no effect in case of finite timeout -->
        <set_order_syncpoint_reached order="this.assignedcontrolled.order" />
      </do_if>

      <set_command command="command.patrol" />

      <set_command_action commandaction="commandaction.scanningto" param="$homeSector" />

      <wait min="1s" max="2s" />


      <!-- SEARCHING  SHIP ************************************************************************ -->

      <label name="protectPlayerShipsCheck" />

      <debug_text
        text="'ProtectSector [%s at %s, %s] : Classes: %s, Classes possible: %s. Station attack: %s. Protect: %s.'.
          [
            this.assignedcontrolled.debugname,
            this.assignedcontrolled.sector.knownname,
            this.assignedcontrolled.fleet.name,
            $classesForAttack,
            $classesAcceptableForAttack,
            $attackStations,
            $protectPlayerShipsInSector
          ]" />

      <do_if value="$classesForAttack.count">
        <set_command command="command.patrol" />
        <set_command_action commandaction="commandaction.scanningto" param="$homeSector" />
        <do_if value="$targetOnResponse? and @$targetOnResponse != null" negate="true">
          <!-- <debug_text text="'ProtectSector [%s at %s, %s] : Search initiated'.
            [
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name
            ]" /> -->
          <do_if value="@$ships.count le 0">
            <include_interrupt_actions ref="ScanForEnemyShips" />
          </do_if>
        </do_if>
        <do_else>
          <create_list name="$ships" />
          <append_to_list name="$ships" exact="$targetOnResponse" />
          <debug_text
            text="'ProtectSector [%s at %s, %s] : Response on attack by: %s. List of ships: %s. Target: %s'.
              [
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.fleet.name,
                @$targetOnResponse.debugname,
                $ships,
                @$target,
              ]" />
          <!-- <set_value name="$targetOnResponse" exact="null" /> -->
          <wait min="10ms" max="50ms" /> <!-- to give a chance to mark the target as own -->
        </do_else>

        <set_value name="$indexShips" exact="1" />
        <do_while value="$indexShips le $ships.count and $target == null">

          <set_value name="$ship" exact="$ships.{$indexShips}" />

          <do_if value="(not $ship.iswreck) and ($ship.isoperational) and ($ship.pilot.exists)">
            <do_if value="$ship.pilot.$ignoreTime?">
              <do_if value="player.age gt $ship.pilot.$ignoreTime">
                <remove_value name="$ship.pilot.$ignoreTime" />
              </do_if>
            </do_if>
            <set_value name="$relation" exact="$ship.relationto.{this.owner}" />
            <debug_text
              text="'ProtectSector [%s at %s, %s] - %s - Target to check: %s {%s}, distance - %s, relation - %s, threshold: %s, share targets: %s, to skip - %s, ignore time: %s, player age: %s'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name,
                  $indexShips,
                  $ship.debugname,
                  $ship.class,
                  this.assignedcontrolled.distanceto.{$ship},
                  $relation,
                  $relationsThresholdInternal,
                  $shareTargetsBetweenFleets,
                  $ship.pilot.$ignoreTime?,
                  @$ship.pilot.$ignoreTime,
                  player.age
                ]" />
            <do_if value="$relation le $relationsThresholdInternal">
              <do_if value="$ship.pilot.$ignoreTime? and not $shareTargetsBetweenFleets" negate="true">
                <set_value name="$target" exact="$ship" />
                <set_value name="$targetClassIsAllowed" exact="true" />
                <do_while
                  value="$targetClassIsAllowed and $target.commander? and $target.commander.canbeattacked and ($target.commander.sector == $target.sector) and $target.commander.isclass.ship">
                  <do_if value="$target.commander.isclass.{$classesAcceptableForAttack}">
                    <debug_text
                      text="'ProtectSector [%s at %s, %s] - %s - New target is: %s {%s}. Selected target was: %s {%s}'
                        .[
                          this.assignedcontrolled.debugname,
                          this.assignedcontrolled.sector.knownname,
                          this.assignedcontrolled.fleet.name,
                          $indexShips,
                          $target.commander.debugname,
                          $target.commander.class,
                          $target.debugname,
                          $target.class
                        ]" />
                    <set_value name="$target" exact="$target.commander" />
                  </do_if>
                  <do_else>
                    <debug_text
                      text="'ProtectSector [%s at %s, %s] - %s - Out of allowed : %s {%s}. Selected target was: %s {%s}'
                        .[
                          this.assignedcontrolled.debugname,
                          this.assignedcontrolled.sector.knownname,
                          this.assignedcontrolled.fleet.name,
                          $indexShips,
                          $target.commander.debugname,
                          $target.commander.class,
                          $target.debugname,
                          $target.class
                        ]" />
                    <set_value name="$targetClassIsAllowed" exact="false" />
                    <set_value name="$target" exact="null" />
                  </do_else>
                </do_while>
              </do_if>
              <do_if value="$target != null and $attackShipsOutOfStationsDistance gt 0km">
                <do_if value="$attackVisibleOnly">
                  <do_if value="$relationsThreshold ge 25">
                    <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station]" recursive="true"
                      multiple="true" sortbydistanceto="this.assignedcontrolled" ishostileto="this.owner" known="true" />
                  </do_if>
                  <do_else>
                    <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station]" recursive="true"
                      multiple="true" sortbydistanceto="this.assignedcontrolled" known="true">
                      <match_relation_to object="this.assignedcontrolled" relation="neutral" comparison="le" />
                    </find_object>
                  </do_else>
                </do_if>
                <do_else>
                  <do_if value="$relationsThreshold ge 25">
                    <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station]" recursive="true"
                      multiple="true" sortbydistanceto="this.assignedcontrolled" ishostileto="this.owner" />
                  </do_if>
                  <do_else>
                    <find_object name="$stations" space="this.assignedcontrolled.sector" class="[class.station]" recursive="true"
                      multiple="true" sortbydistanceto="this.assignedcontrolled">
                      <match_relation_to object="this.assignedcontrolled" relation="neutral" comparison="le" />
                    </find_object>
                  </do_else>
                </do_else>
                <do_for_each name="$station" in="$stations">
                  <!-- <debug_text text="'ProtectSector [%s at %s, %s] - %s - Station to check is near: %s {%s}, distance to target - %s, minimal distance - %s'
                        .[
                          this.assignedcontrolled.debugname,
                          this.assignedcontrolled.sector.knownname,
                          this.assignedcontrolled.fleet.name,
                          $indexShips,
                          $station.debugname,
                          $station.class,
                          $target.distanceto.{$station},
                          $attackShipsOutOfStationsDistance
                        ]" /> -->
                  <do_if value="$target.distanceto.{$station} le $attackShipsOutOfStationsDistance">
                    <debug_text
                      text="'ProtectSector [%s at %s, %s] - Target: %s {%s} is too close to station: %s {%s}, distance - %s, minimal distance - %s'
                      .[
                        this.assignedcontrolled.debugname,
                        this.assignedcontrolled.sector.knownname,
                        this.assignedcontrolled.fleet.name,
                        $target.debugname,
                        $target.class,
                        $station.debugname,
                        $station.class,
                        $target.distanceto.{$station},
                        $attackShipsOutOfStationsDistance
                      ]" />
                    <do_if value="$station.relationto.{this.assignedcontrolled} le $relationsThresholdInternal">
                      <debug_text
                        text="'ProtectSector [%s at %s, %s] - Station: %s {%s} has relation lower than threshold to ship: %s {%s}.'
                        .[
                          this.assignedcontrolled.debugname,
                          this.assignedcontrolled.sector.knownname,
                          this.assignedcontrolled.fleet.name,
                          $station.debugname,
                          $station.class,
                          this.assignedcontrolled.debugname,
                          this.assignedcontrolled.class
                        ]" />
                      <set_value name="$target" exact="null" />
                      <break />
                    </do_if>
                  </do_if>
                </do_for_each>
              </do_if>
            </do_if>
          </do_if>
          <set_value name="$indexShips" exact="$indexShips + 1" />
          <wait min="5ms" max="15ms" profile="flat" />
        </do_while>
        <clear_list list="$ships" />
        <do_if value="$target != null">

          <set_value name="$targetOnResponse" exact="null" />

          <do_if value="$target.coverowner">
            <signal_objects object="$target" param="'LoseCover'" param2="true" />
          </do_if>

          <set_value name="$targetDistanceTo" exact="this.assignedcontrolled.distanceto.{$target}" />

          <add_to_group groupname="$targets" object="$target" />
          <set_value name="$targetInfo"
            exact="table[
            $target = $target,
            $name = $target.name,
            $idcode = $target.idcode,
            $class = $target.class,
            $isShip = true,
            $stationIsUnderConstruction = false
          ]" />

          <debug_text
            text="'ProtectSector [%s at %s, %s] - Final target is: %s {%s}, distance: %s, targetInfo: %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.fleet.name,
                $target.debugname,
                $target.class,
                $targetDistanceTo,
                $targetInfo
              ]" />
          <do_if value="$recordActionsToLogBook">
            <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
            <do_if
              value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
              <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
            </do_if>
            <set_value name="$textEnemy" exact="{1972092401, 1013}.[$textShip, $targetInfo.$name, $targetInfo.$idcode]" />
            <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1031}.[$textUnit, $textEnemy, $textHomeSector]"
              interaction="showonmap" object="this.assignedcontrolled" />
          </do_if>

          <set_value name="$targetPreviousDistanceTo" exact="null" />
          <set_value name="$targetDistanceToIsNotDecreasing" exact="0" />
          <set_value name="$approachingIterationsCount" exact="0" />

          <do_if value="$target.exists and $target.pilot.exists and not $shareTargetsBetweenFleets">
            <set_value name="$target.pilot.$ignoreTime" exact="player.age + 300" />
            <debug_text
              text="'ProtectSector [%s at %s, %s] - Target marked to ignore: %s {%s}, ignore time: %s, player age: %s'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name,
                  $target.debugname,
                  $target.class,
                  $ship.pilot.$ignoreTime?,
                  @$ship.pilot.$ignoreTime,
                  player.age
                ]" />
          </do_if>

          <resume label="targetApproaching" />
        </do_if>
      </do_if>
      <do_elseif value="$attackStations" negate="true">

        <do_if value="this.assignedcontrolled.speed">
          <stop_moving object="this.assignedcontrolled" />
        </do_if>

        <debug_text
          text="'ProtectSector [%s at %s, %s] : Warning! No ship classes (%s or %s) or stations (%s) are selected for attack. Protect is : %s'.
                  [
                    this.assignedcontrolled.debugname,
                    this.assignedcontrolled.sector.knownname,
                    this.assignedcontrolled.fleet.name,
                    $classesForAttack,
                    $classesAcceptableForAttack,
                    $attackStations,
                    $protectPlayerShipsInSector
                  ]" />

        <do_if value="$protectPlayerShipsInSector" negate="true">
          <!-- Player notification -->
          <set_value name="$speakline" exact="10304" comment="Awaiting orders." />
          <run_script name="'player.interaction'">
            <param name="Line" value="$speakline" />
            <param name="MaxQueueDelay" value="10s" />
            <param name="caption" value="{1016, 6}.[this.assignedcontrolled.knownname, this.assignedcontrolled.idcode]" />
            <param name="interactive" value="false" />
          </run_script>
        </do_if>

        <set_value name="$idleDelay" min="30min" max="45min" />

        <resume label="goingIdle" />

      </do_elseif>

      <label name="checkForEnemyStations" />

      <do_if value="$attackStations">

        <!-- SEARCHING  STATION ************************************************************************ -->

        <!-- <debug_text text="'ProtectSector [%s at %s, %s] - Start stations search'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name
            ]" /> -->

        <do_if value="@$stations.count == 0">
          <include_interrupt_actions ref="ScanForEnemyStations" />
        </do_if>

        <set_value name="$target" exact="null" />

        <do_for_each name="$station" in="$stations" counter="$stationIndex">
          <set_value name="$stationRelation" exact="$station.relationto.{this.owner}" />
          <do_if value="$stationRelation le $relationsThresholdInternal">
            <set_value name="$stationDistanceTo" exact="this.assignedcontrolled.distanceto.{$station}" />
            <do_if value="$station.isclass.[class.station]">
              <debug_text
                text="'ProtectSector [%s at %s, %s] - %s - Station to check: %s {%s}, distance - %s, relation - %s, threshold: %s'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name,
                  $stationIndex,
                  $station.debugname,
                  $station.class,
                  $stationDistanceTo,
                  $stationRelation,
                  $relationsThresholdInternal
                ]" />
              <set_value name="$target" exact="$station" />
            </do_if>
            <do_elseif
              value="$station.isclass.[class.buildstorage] and $station.base.isclass.[class.object] and not $station.base.isclass.[class.station]">
              <set_value name="$station" exact="$station.base" />
              <set_value name="$stationDistanceTo" exact="this.assignedcontrolled.distanceto.{$station}" />
              <set_value name="$stationRelation" exact="$station.relationto.{faction.player}" />
              <debug_text
                text="'ProtectSector [%s at %s, %s] - %s - Station under construction to check: %s {%s}, distance - %s, relation - %s, threshold: %s'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name,
                  $stationIndex,
                  $station.debugname,
                  $station.class,
                  $stationDistanceTo,
                  $stationRelation,
                  $relationsThresholdInternal
                ]" />
              <set_value name="$target" exact="$station" />
            </do_elseif>
            <do_if value="$target != null and $macrosToSkip.indexof.{@$target.macro} gt 0 ">
              <debug_text
                text="'ProtectSector [%s at %s, %s] - Station: %s - is an a list of macros to skip: %s. Skipping'
                .[
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name,
                  $target.debugname,
                  macrosToSkip
                ]" />
              <set_value name="$target" exact="null" />
            </do_if>
          </do_if>
          <do_if value="$target != null">
            <break />
          </do_if>
          <wait min="5ms" max="15ms" profile="flat" comment="Wait is just to ensure we don't have infinite loops" />
        </do_for_each>

        <clear_list list="$stations" />

        <do_if value="$target != null">

          <do_if value="$target.isclass.[class.buildstorage]">
            <set_value name="$target" exact="$target.base" />
          </do_if>

          <!-- ATTACKING  STATION ************************************************************************ -->

          <set_value name="$parkedAtPosition" exact="false" />
          <remove_value name="$positionIdle" />

          <add_to_group groupname="$targets" object="$target" />
          <set_value name="$targetInfo"
            exact="table[
            $target = $target,
            $name = $target.name,
            $idcode = $target.idcode,
            $class = $target.class,
            $isShip = false,
            $stationIsUnderConstruction = not $target.isclass.station
          ]" />

          <debug_text
            text="'ProtectSector [%s at %s, %s] - Station target: %s {%s}, distance: %s, relation: %s, targets: %s, targetInfo: %s, iswreck: %s, isoperational: %s, exists: %s, isconstruction: %s, state: %s, macro: %s, isknown: %s, isactive: %s, isfunctional: %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.fleet.name,
                $target.debugname,
                $target.class,
                $stationDistanceTo,
                $stationRelation,
                $targets,
                $targetInfo,
                $target.iswreck,
                $target.isoperational,
                @$target.exists,
                @$target.isconstruction,
                @$target.state,
                @$target.macro,
                @$target.isknown,
                @$target.isactive,
                @$target.isfunctional,
              ]" />

          <do_if value="this.assignedcontrolled.order" comment="Safety check in case the script is called from non-order script">
            <!-- Required for all infinite orders, no effect in case of finite timeout -->
            <set_order_syncpoint_reached order="this.assignedcontrolled.order" />
          </do_if>

          <do_if value="$recordActionsToLogBook">
            <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
            <do_if
              value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
              <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
            </do_if>
            <set_value name="$textEnemy" exact="{1972092401, 1013}.[$textStation, $targetInfo.$name, $targetInfo.$idcode]" />
            <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1032}.[$textUnit, $textEnemy, $textHomeSector]"
              interaction="showonmap" object="this.assignedcontrolled" />
          </do_if>

          <set_value name="this.assignedcontrolled.aipilot.$targetInfo" exact="$targetInfo" />
          <do_if value="@$attackStationsInternal">
            <create_order id="'AttackStationInSector'" object="this.assignedcontrolled" immediate="true">
              <param name="primaryTarget" value="$target" />
              <param name="debugChance" value="100" />
            </create_order>
          </do_if>
          <do_else>
            <do_if value="not @$attackStationsTactical">
              <create_order id="'Attack'" object="this.assignedcontrolled" immediate="true">
                <param name="primarytarget" value="$target" />
                <param name="pursuetargets" value="true" />
                <param name="allowothertargets" value="false" />
                <param name="checkrelation" value="false" />
                <param name="disable" value="false" />
                <param name="maintaindistance" value="false" />
                <param name="targetclasses" value="[class.station]" />
                <param name="squad_attack" value="true" />
                <param name="allowboost" value="true" />
                <param name="forceprimarytarget" value="true" />
              </create_order>
            </do_if>
            <do_else>
              <create_order id="'TacticalOrder'" object="this.assignedcontrolled" immediate="true">
                <param name="selectedtarget" value="$target" />
                <param name="aggressiveness" value="5" />
              </create_order>
            </do_else>
          </do_else>

          <resume label="cleanup" />

        </do_if>
      </do_if>


      <!-- IDLE ************************************************************************ -->

      <label name="goingIdle" />

      <do_if value="$idleDelay?" negate="true">
        <resume label="targetSearching" />
      </do_if>

      <do_if value="player.age gt @$resupplyCheck">
        <include_interrupt_actions ref="ResupplyWorkaroundRefresh" />
        <debug_text
          text="'ProtectSector [%s at %s, %s] - Resupply check'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name
            ]" />
        <signal_objects object="this.assignedcontrolled" param="'resupply'" param2="[this.assignedcontrolled.hullpercentage lt 100]" />
        <set_value name="$resupplyCheck" exact="player.age + 30min" />
      </do_if>
      <!-- prepare group of subordinates to request fleet reinstate -->
      <include_interrupt_actions ref="SubordinatesRefresh" />
      <do_if value="@$IdleAfterStationDestroy == true">
        <remove_value name="$IdleAfterStationDestroy" />
        <set_command command="command.patrol" />
        <set_command_action commandaction="commandaction.calculating" />
        <wait exact="$idleDelay" />
      </do_if>
      <do_else>
        <do_if value="(@$parkingPosition != null) and (not @$parkedAtPosition)">

          <create_orientation name="$orientation" orientation="look_at" refposition="$parkingPosition">
            <position object="this.assignedcontrolled" />
          </create_orientation>

          <set_value name="$parkingTimestamp" exact="player.age" />

          <set_value name="$idleTill" exact="player.age + $idleDelay" />
          <signal_objects object="this.assignedcontrolled" param="'ProtectSectorReScan'" delay="$delayBetweenScansInSeconds" />

          <move_to object="this.assignedcontrolled" destination="this.assignedcontrolled.sector" abortpath="true" forcerotation="true" forceposition="true"
            uselocalhighways="false" boost="true" travel="true">
            <position value="$parkingPosition" />
            <rotation value="$orientation" />
            <interrupt_after_time time="$idleDelay" />
          </move_to>

          <set_value name="$idleTill" exact="0" />

          <set_value name="$parkedAtPosition"
            exact="($parkingPosition != null) and (this.assignedcontrolled.distanceto.{$parkingPosition} le 10km)" />

          <do_if value="$parkedAtPosition and $idleDelay - (player.age - $parkingTimestamp) gt 10s">
            <set_value name="$idleDelay" exact="$idleDelay - (player.age - $parkingTimestamp)" />
          </do_if>
          <do_else>
            <resume label="targetSearching" />
          </do_else>
          <set_value name="$positionIdle" exact="$parkingPosition" />
        </do_if>
        <do_else>
          <do_if value="this.assignedcontrolled.speed">
            <stop_moving object="this.assignedcontrolled" />
          </do_if>
        </do_else>

        <do_if value="(not $positionIdle?) or (player.age ge @$positionIdleTime)">
          <find_object name="$objects" space="this.assignedcontrolled.sector"
            class="[class.station, class.gate, class.highwayentrygate, class.highwayexitgate]" known="true"
            recursive="true" multiple="true">
            <match_relation_to object="this.assignedcontrolled" relation="neutral" comparison="ge" />
          </find_object>
          <do_if value="$objects.count gt 0">
            <set_value name="$object" exact="$objects.random" />
            <get_safe_pos result="$positionIdle" object="$object" sector="this.assignedcontrolled.sector" radius="this.assignedcontrolled.size" min="5km"
              max="15km" ignored="this.assignedcontrolled" />
            <remove_value name="$object" />
          </do_if>
          <do_else>
            <get_safe_pos result="$positionIdle" sector="this.assignedcontrolled.sector" radius="this.assignedcontrolled" ignored="this.assignedcontrolled" />
          </do_else>
          <remove_value name="$objects" />
          <set_value name="$positionIdleTime" exact="player.age + 300" />
        </do_if>

        <do_if value="$idleDelay gt 0">
          <set_command command="command.patrol" />
          <set_command_action commandaction="commandaction.investigating" param="this.assignedcontrolled.sector" />
          <do_if value="$homeSector.hashazardousregion or $idleDelay le $delayBetweenScansInSeconds">
            <debug_text
              text="'ProtectSector [%s at %s, %s] - Hazardous region - waiting for %s seconds'.
                [
                  this.assignedcontrolled.debugname,
                  this.assignedcontrolled.sector.knownname,
                  this.assignedcontrolled.fleet.name,
                  $idleDelay
                ]" />
            <wait exact="if $idleDelay gt $delayBetweenScansInSeconds then $delayBetweenScansInSeconds else [$idleDelay, 300ms].max" />
          </do_if>
          <do_else>
            <set_value name="$idleTill" exact="player.age + $idleDelay" />
            <signal_objects object="this.assignedcontrolled" param="'ProtectSectorReScan'" delay="$delayBetweenScansInSeconds" />
            <!-- <move_to object="this.assignedcontrolled" destination="this.assignedcontrolled.sector" forceposition="true" uselocalhighways="false"
            boost="true"
              travel="true">
              <position value="$positionIdle" />
              <interrupt_after_time time="$idleDelay" />
            </move_to> -->
            <run_script name="'move.idle'">
              <param name="TimeOut" value="$idleDelay" />
              <param name="anchorpos_sector" value="$positionIdle" />
              <param name="MaxDistance" value="10km" />
            </run_script>
            <do_if value="$idleTill gt player.age">
              <set_value name="$idleDelay" exact="$idleTill - player.age" />
              <resume label="goingIdle" />
            </do_if>
            <do_else>
              <set_value name="$idleTill" exact="0" />
            </do_else>
          </do_else>
        </do_if>
        <do_else>
          <wait exact="300ms" />
        </do_else>
      </do_else>

      <set_value name="$idleDelay" exact="$updateTime" />

      <resume label="targetSearching" />

      <!-- APPROACHING ************************************************************************ -->
      <label name="targetApproaching" />


      <do_if value="$target? and $target != null and $target.exists and not $target.iswreck and $target.sector == $homeSector">

        <remove_value name="$positionIdle" />

        <set_value name="$targetDistanceTo" exact="this.assignedcontrolled.distanceto.{$target}" />

        <set_value name="$targetOptimalDistanceForAttack"
          exact="this.assignedcontrolled.size + this.assignedcontrolled.maxradarrange * $attackDistanceAsPercentageOfRadarRange * 0.01 + $target.size" />

        <debug_text
          text="'ProtectSector [%s at %s, %s] - move iteration : %s {%s} status: iswreck: %s, isoperational: %s,  pilot: %s (%s), distance - %s, radar percentage: %s, acceptable distance - %s'
            .[
              this.assignedcontrolled.debugname,
              this.assignedcontrolled.sector.knownname,
              this.assignedcontrolled.fleet.name,
              $target.debugname,
              $target.class,
              $target.iswreck,
              $target.isoperational,
              $target.pilot,
              $target.pilot?,
              $targetDistanceTo,
              $attackDistanceAsPercentageOfRadarRange,
              $targetOptimalDistanceForAttack
            ]" />

        <set_value name="$approachingIterationsCount" operation="add" />

        <do_if value="$targetDistanceTo gt $targetOptimalDistanceForAttack">

          <do_if value="$targetPreviousDistanceTo? and $targetPreviousDistanceTo != null">
            <do_if value="$targetPreviousDistanceTo le $targetDistanceTo">
              <do_if
                value="not $targetDistanceToIsNotDecreasing? or @$targetDistanceToIsNotDecreasing == null or @$targetDistanceToIsNotDecreasing lt 1">
                <set_value name="$targetDistanceToIsNotDecreasing" exact="1" />
              </do_if>
              <do_elseif value="@$targetDistanceToIsNotDecreasing ge 1">
                <set_value name="$targetDistanceToIsNotDecreasing" operation="add" />
              </do_elseif>
            </do_if>
            <do_else>
              <set_value name="$targetDistanceToIsNotDecreasing" exact="null" />
            </do_else>
          </do_if>

          <do_if value="@$targetDistanceToIsNotDecreasing ge 3 or $approachingIterationsCount ge 10">
            <debug_text
              text="'ProtectSector [%s at %s, %s] - Too fast for us : %s {%s} status: iswreck: %s, isoperational: %s,  pilot: %s (%s), distance: not decreasing count: %s, iterations count: %s'
                  .[
                    this.assignedcontrolled.debugname,
                    this.assignedcontrolled.sector.knownname,
                    this.assignedcontrolled.fleet.name,
                    $target.debugname,
                    $target.class,
                    $target.iswreck,
                    $target.isoperational,
                  @$target.pilot,
                  $target.pilot?,
                  @$targetDistanceToIsNotDecreasing,
                  @$approachingIterationsCount
                  ]" />
            <do_if value="$recordActionsToLogBook">
              <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
              <do_if
                value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
                <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
              </do_if>
              <set_value name="$textEnemy" exact="{1972092401, 1013}.[$textShip, $targetInfo.$name, $targetInfo.$idcode]" />
              <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1044}.[$textUnit, $textEnemy, $textHomeSector]"
                interaction="showonmap" object="this.assignedcontrolled" />
            </do_if>
            <set_value name="$targetPreviousDistanceTo" exact="null" />
            <set_value name="$targetDistanceToIsNotDecreasing" exact="0" />
            <set_value name="$approachingIterationsCount" exact="0" />
            <resume label="targetSearching" />
          </do_if>

          <set_value name="$parkedAtPosition" exact="false" />
          <set_command command="command.patrol" />
          <set_command_action commandaction="commandaction.flyingto" param="$target" />

          <get_safe_pos object="$target" zone="$target.zone" radius="this.assignedcontrolled.size / 2" allowyaxis="true"
            result="$destination"
            ignored="this.assignedcontrolled" sector="$homeSector" />

          <set_value name="$targetPreviousDistanceTo" exact="$targetDistanceTo" />

          <move_to object="this.assignedcontrolled" destination="$target.zone" boost="not $shieldsPreserveOnFlight" travel="true"
            forceposition="false"
            finishonapproach="true" commandaction="false">
            <position value="$destination" max="this.assignedcontrolled.size + $target.size" />
            <interrupt>
              <conditions>
                <check_any>
                  <event_object_changed_zone group="$targets" />
                  <event_object_destroyed group="$targets" />
                  <event_object_abandoned group="$targets" />
                  <event_object_changed_sector group="$targets" />
                  <event_object_target_invalid group="$targets" />
                </check_any>
              </conditions>
              <actions>
                <debug_text
                  text="'ProtectSector [%s at %s, %s] - moving is interrupted by %s : %s {%s} status: iswreck: %s, isoperational: %s,  pilot: %s (%s), distance - %s, acceptable distance - %s'
                    .[
                      this.assignedcontrolled.debugname,
                      this.assignedcontrolled.sector.knownname,
                      this.assignedcontrolled.fleet.name,
                      event.name,
                      $target.debugname,
                      $target.class,
                      $target.iswreck,
                      $target.isoperational,
                      $target.pilot,
                      $target.pilot?,
                      $targetDistanceTo,
                      $targetOptimalDistanceForAttack
                    ]" />
                <do_if value="$recordActionsToLogBook">
                  <do_if value="event.name == 'event_object_destroyed'">
                    <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
                    <do_if
                      value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
                      <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
                    </do_if>
                    <set_value name="$textEnemy" exact="{1972092401, 1013}.[$textShip, $targetInfo.$name, $targetInfo.$idcode]" />
                    <write_to_logbook category="general" title="$textTitle"
                      text="{1972092401, 1041}.[$textUnit, $textEnemy, $textHomeSector]" interaction="showonmap"
                      object="this.assignedcontrolled" />
                  </do_if>
                </do_if>
              </actions>
            </interrupt>
          </move_to>

          <wait min="5ms" max="15ms" profile="flat" />

          <resume label="targetApproaching" />

        </do_if>
        <do_else>

          <resume label="targetAttacking" />

        </do_else>
      </do_if>
      <do_else>

        <resume label="goingIdle" />

      </do_else>

      <!-- ATTACKING ************************************************************************ -->

      <label name="targetAttacking" />

      <set_value name="$targetDistanceTo" exact="this.assignedcontrolled.distanceto.{$target}" />

      <do_if value="$target.exists and not $target.iswreck and $target.sector == $homeSector">

        <remove_value name="$positionIdle" />

        <do_if value="not $targetOptimalDistanceForAttack? or $targetDistanceTo le $targetOptimalDistanceForAttack">
          <debug_text
            text="'ProtectSector [%s at %s, %s] - Run order.fight.attack.object : %s {%s} status: iswreck: %s, isoperational: %s,  pilot: %s (%s), distance - %s, acceptable distance - %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.fleet.name,
                $target.debugname,
                $target.class,
                $target.iswreck,
                $target.isoperational,
                $target.pilot,
                $target.pilot?,
                $targetDistanceTo,
                $targetOptimalDistanceForAttack
              ]" />
          <do_if value="$recordActionsToLogBook">
            <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
            <do_if
              value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
              <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
            </do_if>
            <set_value name="$textEnemy" exact="{1972092401, 1013}.[$textShip, $targetInfo.$name, $targetInfo.$idcode]" />
            <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1032}.[$textUnit, $textEnemy, $textHomeSector]"
              interaction="showonmap" object="this.assignedcontrolled" />
          </do_if>
          <set_command command="command.patrol" />
          <set_command_action commandaction="commandaction.attackingto" param="$target" />
          <run_script name="'order.fight.attack.object'">
            <param name="primarytarget" value="$target" />
            <param name="pursuetargets" value="false" />
            <param name="allowothertargets" value="true" />
            <param name="checkrelation" value="$attackHostileOnly" />
            <param name="disable" value="$breakOnDestructionPercentage gt 0" />
            <param name="disablehullpercentagethreshold" value="$breakOnDestructionPercentage" />
            <param name="maintaindistance" value="true" />
            <param name="squad_attack" value="true" />
            <param name="uncover" value="true" />
            <param name="targetclasses" value="$classesAcceptableForAttack" />
            <param name="allowboost" value="not $shieldsPreserveOnFlight" />
            <param name="forceprimarytarget" value="true" />
          </run_script>

          <set_value name="$targetDistanceTo" exact="this.assignedcontrolled.distanceto.{$target}" />

          <debug_text
            text="'ProtectSector [%s at %s, %s] - After run order.fight.attack.object : %s {%s} status: iswreck: %s, isoperational: %s,  pilot: %s (%s), distance - %s, acceptable distance - %s'
              .[
                this.assignedcontrolled.debugname,
                this.assignedcontrolled.sector.knownname,
                this.assignedcontrolled.fleet.name,
                $target.debugname,
                $target.class,
                $target.iswreck,
                $target.isoperational,
                $target.pilot,
                $target.pilot?,
                $targetDistanceTo,
                $targetOptimalDistanceForAttack
              ]" />

          <do_if value="$target.exists and not $target.iswreck and $pursueFleeingTarget and $target.sector == $homeSector">
            <resume label="targetApproaching" />
          </do_if>
        </do_if>
        <do_else>
          <resume label="targetApproaching" />
        </do_else>
      </do_if>

      <resume label="goingIdle" />

      <!-- HOME ********************************************************************************* -->
      <label name="flightToHomeSector" />

      <do_if value="this.assignedcontrolled.sector == $homeSector">
        <resume label="start" />
      </do_if>

      <get_jump_path component="$jumpPath" multiple="true" uselocalhighways="true" refobject="this.assignedcontrolled"
        useknownpath="this.isplayerowned">
        <start object="this.assignedcontrolled" />
        <end object="$homeSector" />
      </get_jump_path>

      <do_if value="$jumpPath.count lt 2">
        <debug_text
          text="'ProtectSector [%s at %s, %s] - ERROR: we are not at the target sector, but no jump path found from %s %s to %s %s. aborting.'.
          [
            this.assignedcontrolled.debugname,
            this.assignedcontrolled.sector.knownname,
            this.assignedcontrolled.fleet.name,
            this.sector.knownname,
            this.sector,
            $homeSector.knownname,
            $homeSector
          ]" />
        <do_all exact="$jumpPath.count" counter="$pathIndex">
          <debug_text text="'jumpPath entry %s: %s %s %s'.[$pathIndex, $jumpPath.{$pathIndex}.class, $jumpPath.{$pathIndex}.knownname, $jumpPath.{$pathIndex}]" />
        </do_all>
        <resume label="cleanup" />
      </do_if>

      <do_if value="@$jumpPath.last.zone != null">
        <set_value name="$homeLocation" exact="$jumpPath.last.zone" />
      </do_if>
      <do_else>
        <find_zone name="$homeLocations" space="$homeSector" normalzone="true" sortbydistanceto="$jumpPath.last" multiple="true" />
        <do_if value="$homeLocations.count gt 0">
          <set_value name="$homeLocation" exact="$homeLocations.{1}" />
        </do_if>
        <remove_value name="$homeLocations" />
      </do_else>

      <get_safe_pos result="$destinationAtHome" zone="$homeLocation" radius="this.assignedcontrolled.size" min="1km" max="5km" object="$jumpPath.last" />

      <remove_value name="$jumpPath" />

      <set_command command="command.movetozone" param="$homeLocation" />
      <set_command_action commandaction="commandaction.flyingto" param="$homeLocation" />

      <do_if value="$recordActionsToLogBook">
        <set_value name="$textUnit" exact="{1972092401, 1011}.[this.assignedcontrolled.name, this.assignedcontrolled.idcode]" />
        <do_if
          value="@this.assignedcontrolled.subordinates.count gt 0 and @this.assignedcontrolled.toplevelcommander == this.assignedcontrolled">
          <set_value name="$textUnit" exact="{1972092401, 1012}.[this.assignedcontrolled.fleet.name, $textUnit]" />
        </do_if>
        <write_to_logbook category="general" title="$textTitle" text="{1972092401, 1022}.[$textUnit, $textHomeSector]"
          interaction="showonmap" object="this.assignedcontrolled" />
      </do_if>

      <do_if value="@$desiredParkingPosition != null and @$desiredParkingPosition.{2} != null">
        <set_value name="$destinationAtHome" exact="@$desiredParkingPosition.{2}" />
      </do_if>

      <move_to object="this.assignedcontrolled" destination="$homeLocation" travel="true" forceposition="false" finishonapproach="true"
        commandaction="false">
        <position value="$destinationAtHome" min="5km" max="6km" />
      </move_to>

      <remove_value name="$homeLocation" />
      <remove_value name="$destinationAtHome" />

      <wait min="5ms" max="15ms" profile="flat" />

      <resume label="targetSearching" />

      <label name="cleanup" />
    </actions>
  </attention>
  <on_abort>
    <do_for_each name="$subordinate" in="this.$escortgroup">
      <remove_value name="$subordinate.pilot.$playerOwnedWorkaroundForRestock" />
    </do_for_each>
    <remove_value name="this.assignedcontrolled.pilot.$playerOwnedWorkaroundForRestock" />
    <debug_text
      text="'ProtectSector [%s at %s, %s] - Aborted. Commander: %s. Killed: %s.'.
          [
            @this.assignedcontrolled.debugname,
            @this.assignedcontrolled.sector.knownname,
            @this.assignedcontrolled.fleet.name,
            @this.assignedcontrolled.fleet.commander.debugname,
            @event.name == 'event_object_destroyed'
          ]" />
  </on_abort>
</aiscript>